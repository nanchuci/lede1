# All rights reserved.
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.

include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/kernel.mk

PKG_NAME:=mt7615d
P4REV:=9
PKG_VERSION:=5.1.0.0

PKG_BUILD_PARALLEL:=1

PKG_BUILD_DIR:=$(KERNEL_BUILD_DIR)/$(PKG_NAME)
PKG_KCONFIG:= \
	SUPPORT_OPENWRT \
	WIFI_DRIVER \
	FIRST_IF_MT7615E \
	FIRST_IF_MT7622 \
	FIRST_IF_MT7626 \
	FIRST_IF_NONE \
	SECOND_IF_NONE \
	SECOND_IF_MT7615E \
	THIRD_IF_NONE \
	THIRD_IF_MT7615E \
	RT_FIRST_CARD \
	RT_SECOND_CARD \
	RT_THIRD_CARD \
	RT_FIRST_IF_RF_OFFSET \
	RT_SECOND_IF_RF_OFFSET \
	RT_THIRD_IF_RF_OFFSET \
	MT_WIFI \
	MT_WIFI_PATH \
	FIRST_IF_EEPROM_FLASH \
	FIRST_IF_EEPROM_PROM \
	FIRST_IF_EEPROM_EFUSE \
	RT_FIRST_CARD_EEPROM \
	SECOND_IF_EEPROM_FLASH \
	SECOND_IF_EEPROM_PROM \
	SECOND_IF_EEPROM_EFUSE \
	RT_SECOND_CARD_EEPROM \
	THIRD_IF_EEPROM_FLASH \
	THIRD_IF_EEPROM_PROM \
	THIRD_IF_EEPROM_EFUSE \
	RT_THIRD_CARD_EEPROM \
	MULTI_INF_SUPPORT \
	WIFI_BASIC_FUNC \
	DOT11_N_SUPPORT \
	DOT11_VHT_AC \
	G_BAND_256QAM_SUPPORT \
	TPC_SUPPORT \
	ICAP_SUPPORT \
	SPECTRUM_SUPPORT \
	BACKGROUND_SCAN_SUPPORT \
	SMART_CARRIER_SENSE_SUPPORT \
	MT_DFS_SUPPORT \
	OFFCHANNEL_SCAN_FEATURE \
	DPP_SUPPORT \
	HDR_TRANS_TX_SUPPORT \
	HDR_TRANS_RX_SUPPORT \
	DBDC_MODE \
	MULTI_PROFILE_SUPPORT \
	DEFAULT_5G_PROFILE \
	WSC_INCLUDED \
	WSC_V2_SUPPORT \
	DOT11W_PMF_SUPPORT \
	TXBF_SUPPORT \
	FAST_NAT_SUPPORT \
	WHNAT_SUPPORT \
	FTM_SUPPORT \
	MBO_SUPPORT \
	IGMP_SNOOP_SUPPORT \
	RTMP_FLASH_SUPPORT \
	PRE_CAL_TRX_SET1_SUPPORT \
	RLM_CAL_CACHE_SUPPORT \
	PRE_CAL_TRX_SET2_SUPPORT \
	RF_LOCKDOWN_SUPPORT \
	LINK_TEST_SUPPORT \
	ATE_SUPPORT \
	PASSPOINT_R2 \
	UAPSD \
	TCP_RACK_SUPPORT \
	RED_SUPPORT \
	FDB_SUPPORT \
	FIRST_IF_IPAILNA \
	FIRST_IF_IPAELNA \
	FIRST_IF_EPAELNA \
	SECOND_IF_IPAILNA \
	SECOND_IF_IPAELNA \
	SECOND_IF_EPAELNA \
	THIRD_IF_EPAELNA \
	THIRD_IF_IPAILNA \
	THIRD_IF_IPAELNA \
	RLT_MAC \
	RLT_BBP \
	RLT_RF \
	RTMP_MAC \
	RTMP_BBP \
	RTMP_RF \
	RTMP_PCI_SUPPORT \
	RTMP_USB_SUPPORT \
	RTMP_RBUS_SUPPORT \
	WIFI_MODE_AP \
	WIFI_MODE_STA \
	WIFI_MODE_BOTH \
	MT_AP_SUPPORT \
	WDS_SUPPORT \
	WIFI_EAP_FEATURE \
	VLAN_SUPPORT \
	MLME_MULTI_QUEUE_SUPPORT \
	TXRX_STAT_SUPPORT \
	SNIFFER_SUPPORT \
	ANTENNA_CONTROL_SUPPORT \
	MGMT_TXPWR_CTRL \
	CHUTIL_SUPPORT \
	NF_SUPPORT \
	RA_PHY_RATE_SUPPORT \
	AMPDU_CONF_SUPPORT \
	ACK_CTS_TIMEOUT_SUPPORT \
	MBSS_SUPPORT \
	APCLI_SUPPORT \
	APCLI_CERT_SUPPORT \
	MAC_REPEATER_SUPPORT \
	MWDS \
	MUMIMO_SUPPORT \
	MU_RA_SUPPORT \
	DOT11R_FT_SUPPORT \
	DOT11K_RRM_SUPPORT \
	INTERWORKING \
	MAP_SUPPORT \
	MAP_R2_VER_SUPPORT \
	OFFCHANNEL_SCAN_FEATURE \
	OCE_SUPPORT \
	DPP_FEATURE \
	ENTERPRISE_AP_SUPPORT \
	DYNAMIC_VLAN_SUPPORT \
	RA_HW_NAT \
	RA_HW_NAT_WIFI_NEW_ARCH \
	CFG80211_SUPPORT \
	CUSTOMISED_HOSTAPD_SUPPORT \
	APCLI_STA_SUPPORT \
	WDS_STA_SUPPORT \
	MBSS_AS_WDS_AP_SUPPORT \
	DSCP_QOS_MAP_SUPPORT \
	DSCP_PRI_SUPPORT \
	HOSTAPD_MAP_SUPPORT \
	MIN_PHY_RATE_SUPPORT \
	FAST_UP_RATE_SUPPORT \
	RADIUS_MAC_AUTH_SUPPORT \
	CON_WPS_SUPPORT \
	MCAST_RATE_SPECIFIC \
	VOW_SUPPORT \
	FQ_SCH_SUPPORT \
	BAND_STEERING \
	LED_CONTROL_SUPPORT \
	WLAN_HOOK \
	RADIUS_ACCOUNTING_SUPPORT \
	GREENAP_SUPPORT \
	PCIE_ASPM_DYM_CTRL_SUPPORT \
	COEX_SUPPORT \
	EASY_SETUP_SUPPORT \
	EVENT_NOTIFIER_SUPPORT \
	AIR_MONITOR \
	WNM_SUPPORT \
	WIFI_MSI_SUPPORT \
	WPA3_SUPPORT \
	OWE_SUPPORT \
	VENDOR_FEATURE10_SUPPORT \
	VENDOR_FEATURE11_SUPPORT \
	RCSA_SUPPORT \
	ETH_CONVERT_SUPPORT \
	WIFI_MT_MAC \
	RLT_MAC \
	RTMP_MAC \
	MT_MAC \
	CHIP_MT7603E \
	CHIP_MT7615E \
	CHIP_MT7622 \
	CHIP_MT7663E \
	CHIP_MT7626

PKG_CONFIG_DEPENDS:=$(foreach c, $(PKG_KCONFIG),$(if $(CONFIG_MTK_$c),CONFIG_$(c)))

include $(INCLUDE_DIR)/package.mk

TAR_CMD=$(HOST_TAR) -C $(1)/ $(TAR_OPTIONS)

define KernelPackage/mt7615d
  CATEGORY:=Kernel modules
  TITLE:=MTK wifi AP driver
  DEPENDS:=@TARGET_ramips +MTK_CFG80211_SUPPORT:kmod-cfg80211 +@DRIVER_11AC_SUPPORT +@DRIVER_11N_SUPPORT +@DRIVER_11W_SUPPORT
  KCONFIG:= \
	CONFIG_PCI_MSI=y \
	CONFIG_NET_SCH_FQ=y
ifneq ($(CONFIG_MTK_WHNAT_SUPPORT),y)
  FILES:=$(PKG_BUILD_DIR)/mt_wifi_ap/mt_wifi.ko \
	$(PKG_BUILD_DIR)/mt_wifi/embedded/plug_in/whnat/mt_whnat.ko
  AUTOLOAD:=$(call AutoProbe,mt_wifi mt_whnat)
else
  FILES:=$(PKG_BUILD_DIR)/mt_wifi_ap/mt_wifi.ko
  AUTOLOAD:=$(call AutoProbe,mt_wifi)
endif
  SUBMENU:=Wireless Drivers
  MENU:=1
endef

define KernelPackage/mt7615d/config
	source "$(SOURCE)/config.in"
endef

define KernelPackage/mt7615d_dbdc
  CATEGORY:=Kernel modules
  TITLE:=MTK wifi AP driver
  DEPENDS:=@TARGET_ramips +kmod-mt7615d +maccalc
  SUBMENU:=Wireless Drivers
  MENU:=1
endef

define KernelPackage/mt7615d_dbdc/config
	select MTK_WIFI_DRIVER
	select MTK_FIRST_IF_MT7615E
	select MTK_MT_WIFI
	select MTK_WIFI_MT_MAC
	select MTK_CHIP_MT7615E
	select MTK_DBDC_MODE
endef

NOSTDINC_FLAGS = \
	-I$(STAGING_DIR)/usr/include/mac80211-backport/uapi \
	-I$(STAGING_DIR)/usr/include/mac80211-backport \
	-I$(STAGING_DIR)/usr/include/mac80211/uapi \
	-I$(STAGING_DIR)/usr/include/mac80211 \
	-include backport/autoconf.h \
	-include backport/backport.h

define Build/Compile
	+$(MAKE) $(PKG_JOBS) -C "$(LINUX_DIR)" \
		$(KERNEL_MAKE_FLAGS) \
		CROSS_COMPILE="$(TARGET_CROSS)" \
		ARCH="$(LINUX_KARCH)" \
		$(foreach c, $(PKG_KCONFIG),$(if $(CONFIG_MTK_$c),CONFIG_$(c)=$(CONFIG_MTK_$(c)))) \
		M="$(PKG_BUILD_DIR)/mt_wifi_ap" \
		$(if $(CONFIG_MTK_CFG80211_SUPPORT),NOSTDINC_FLAGS="$(NOSTDINC_FLAGS)") \
		V=1 \
		modules
endef

define Build/Install
        :
endef

define KernelPackage/mt7615d/install
	:
endef

define KernelPackage/mt7615d_dbdc/install
	$(INSTALL_DIR) $(1)/bin/
	$(INSTALL_DIR) $(1)/etc/init.d/
	$(INSTALL_DIR) $(1)/etc/config/
	$(INSTALL_DIR) $(1)/etc/hotplug.d/net/
	$(INSTALL_DIR) $(1)/lib/wifi/
	$(INSTALL_DIR) $(1)/etc/wireless/
	$(INSTALL_DIR) $(1)/etc_ro/wlan/
	$(INSTALL_DIR) $(1)/etc_ro/Wireless/RT2860AP/
	$(INSTALL_DIR) $(1)/etc/hotplug.d/wifi/
	$(INSTALL_DIR) $(1)/etc/hotplug.d/firmware/
	$(INSTALL_DIR) $(1)/lib/preinit/
	$(INSTALL_DIR) $(1)/lib/firmware/mediatek/
	$(INSTALL_DIR) $(1)/lib/firmware/mediatek/ePAeLNA/
	$(INSTALL_DIR) $(1)/lib/firmware/mediatek/ePAiLNA/
	$(INSTALL_DIR) $(1)/lib/firmware/mediatek/iPAeLNA/
	$(INSTALL_DIR) $(1)/lib/firmware/mediatek/iPAiLNA/
	$(INSTALL_DIR) $(1)/lib/wifi $(1)/lib/netifd/wireless $(1)/etc/uci-defaults
	$(INSTALL_BIN) ./src/bin/mt7615/SingleSKU.dat $(1)/etc_ro/Wireless/RT2860AP/
	$(INSTALL_BIN) ./src/bin/mt7615/SingleSKU_BF.dat $(1)/etc_ro/Wireless/RT2860AP/
	$(INSTALL_BIN) ./src/bin/mt7615/wps_pbc $(1)/bin/
	$(INSTALL_BIN) ./src/bin/mt7615/l1profile.dat $(1)/etc/wireless/
	$(INSTALL_BIN) ./src/bin/mt7615/MT7615_EEPROM1.bin $(1)/etc_ro/wlan/
	$(INSTALL_BIN) ./src/bin/mt7615/11-mtk-wifi-e2p $(1)/etc/hotplug.d/firmware/
	$(INSTALL_DATA) ./src/bin/mt7615/hwacc0 $(1)/etc/config/
	$(INSTALL_DATA) ./src/bin/mt7615/002-hwacc $(1)/etc/hotplug.d/net/
	$(INSTALL_DATA) ./files/lib/wifi/mt_dbdc.sh $(1)/lib/wifi
	$(INSTALL_BIN) ./files/lib/netifd/wireless/mt_dbdc.sh $(1)/lib/netifd/wireless
	$(INSTALL_DATA) ./src/bin/mt7615/001-wifi.sh $(1)/etc/hotplug.d/wifi/
	$(INSTALL_DATA) ./files/etc/uci-defaults/10_mt7615_dbdc $(1)/etc/uci-defaults/10_mt7615_dbdc
	$(INSTALL_DATA) ./src/bin/mt7615/99-hwacc $(1)/etc/uci-defaults/
	$(INSTALL_DATA) ./src/bin/mt7615/luci-hwacc $(1)/etc/uci-defaults/
	$(INSTALL_DATA) ./src/bin/mt7615/luci-i18n-hwacc-zh-cn $(1)/etc/uci-defaults/
	$(INSTALL_BIN) ./src/bin/mt7615/MT7615_cr4.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/mt7615_patch_e3_hdr.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/WIFI_RAM_CODE_MT7615.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/MT7615_cr4_noReOrdering.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/MT7615_cr4_plain.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/MT7615_cr4_plain_20141024_1.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/MT7615_cr4_plain_20150206_1_asic.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/WIFI_RAM_CODE_MT7615_E1.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/WIFI_RAM_CODE_MT7615_plain.bin $(1)/lib/firmware/mediatek/
	$(INSTALL_BIN) ./src/bin/mt7615/ePAeLNA/MT7615_EEPROM.bin $(1)/lib/firmware/mediatek/ePAeLNA/
	$(INSTALL_BIN) ./src/bin/mt7615/ePAiLNA/MT7615_EEPROM.bin $(1)/lib/firmware/mediatek/ePAiLNA/
	$(INSTALL_BIN) ./src/bin/mt7615/iPAeLNA/MT7615_EEPROM.bin $(1)/lib/firmware/mediatek/iPAeLNA/
	$(INSTALL_BIN) ./src/bin/mt7615/iPAiLNA/MT7615_EEPROM.bin $(1)/lib/firmware/mediatek/iPAiLNA/
	$(INSTALL_BIN) ./src/bin/mt7615/91_load_wifi.sh $(1)/lib/preinit/91_load_wifi
	$(INSTALL_BIN) ./src/bin/mt7615/firmware.sh $(1)/etc/init.d/firmware
	$(INSTALL_BIN) ./src/bin/mt7615/hwacc $(1)/etc/init.d/
	$(INSTALL_BIN) ./src/bin/mt7615/mtkwifi $(1)/etc/init.d/
endef

$(eval $(call KernelPackage,mt7615d))
$(eval $(call KernelPackage,mt7615d_dbdc))
